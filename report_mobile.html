
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>B√°o C√°o T√†i Ch√≠nh - Mobile</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --primary: #3A464E;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #FE3A45;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e0e0e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 80px; /* Space for bottom nav */
            overflow-x: hidden;
        }

        /* Utility Classes */
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .bg-success-light { background: #e8f5e9; color: var(--success); }
        .bg-warning-light { background: #fff3e0; color: var(--warning); }
        .bg-danger-light { background: #ffebee; color: var(--danger); }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #2c3e50 100%);
            color: white;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .header p { font-size: 12px; opacity: 0.9; }

        /* Tab System */
        .tab-content { display: none; padding: 16px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        
        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .kpi-card { background: white; border-radius: 12px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: center; }
        .kpi-label { font-size: 11px; color: var(--text-light); margin-bottom: 4px; font-weight: 500; }
        .kpi-value { font-size: 20px; font-weight: 700; color: var(--primary); line-height: 1.2; margin-bottom: 2px; }
        .kpi-sub { font-size: 10px; color: var(--text-light); }

        /* Ranking List */
        .ranking-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 12px; flex-shrink: 0; }
        .ranking-info { flex: 1; }
        .ranking-name { font-weight: 700; font-size: 15px; }
        .ranking-detail { font-size: 12px; color: var(--text-light); margin-top: 2px; }
        .ranking-badge { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 12px; white-space: nowrap; }

        /* Accordion */
        .accordion { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .accordion-header { padding: 16px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff; }
        .accordion-content { padding: 0 16px 16px; display: none; font-size: 13px; line-height: 1.5; color: #555; border-top: 1px solid #f0f0f0; }
        .accordion-content.open { display: block; }
        .accordion-content ul { padding-left: 20px; margin-top: 8px; }
        .accordion-content li { margin-bottom: 6px; }

        /* Segmented Control */
        .segmented-control { display: flex; background: #e0e0e0; padding: 4px; border-radius: 8px; margin-bottom: 16px; }
        .segment-btn { flex: 1; padding: 8px; border: none; background: transparent; border-radius: 6px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; }
        .segment-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Toggle Switch */
        .toggle-container { display: flex; justify-content: center; margin-bottom: 16px; }
        .toggle-wrapper { display: flex; background: #e0e0e0; border-radius: 20px; padding: 3px; position: relative; }
        .toggle-btn { padding: 6px 20px; border-radius: 18px; border: none; background: transparent; font-size: 13px; font-weight: 600; color: #666; z-index: 1; position: relative; cursor: pointer; transition: color 0.2s; }
        .toggle-btn.active { color: var(--primary); }
        .toggle-bg { position: absolute; top: 3px; bottom: 3px; left: 3px; width: 50%; background: white; border-radius: 18px; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Chips */
        .chips-container { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
        .chip { padding: 8px 16px; background: white; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; font-weight: 500; color: #666; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Buttons */
        .btn { display: block; width: 100%; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center; border: none; cursor: pointer; margin-bottom: 12px; transition: opacity 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--primary); }
        .btn:active { opacity: 0.8; }

        /* Action List */
        .action-item { padding: 12px 0; border-bottom: 1px dashed var(--border); display: flex; align-items: flex-start; }
        .action-item:last-child { border-bottom: none; }
        .action-check { margin-right: 10px; color: var(--success); font-weight: bold; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 4px; cursor: pointer; color: #999; transition: color 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; margin-bottom: 2px; }
        .nav-label { font-size: 10px; font-weight: 500; }

    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üìä B√°o C√°o T√†i Ch√≠nh</h1>
        <p>Th√°ng 1-10 2024 ‚Ä¢ S, T, I Group</p>
    </div>

    <!-- TAB 1: T·ªîNG QUAN -->
    <div id="tab-overview" class="tab-content active">
        <!-- KPI Grid -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">T·ªïng Doanh Thu</div>
                <div class="kpi-value">66.383 M</div>
                <div class="kpi-sub">~6.638 M/th√°ng</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">T·ªïng LNTT</div>
                <div class="kpi-value">9.084 M</div>
                <div class="kpi-sub">LN/DT: 13.68%</div>
            </div>
            <div class="kpi-card bg-success-light" style="box-shadow: none; border: 1px solid #c8e6c9;">
                <div class="kpi-label text-success">Ho·∫°t ƒë·ªông t·ªët nh·∫•t</div>
                <div class="kpi-value text-success" style="font-size: 18px">T</div>
                <div class="kpi-sub text-success">LN/DT 24.7% ‚úÖ</div>
            </div>
            <div class="kpi-card bg-warning-light" style="box-shadow: none; border: 1px solid #ffe0b2;">
                <div class="kpi-label text-warning">S·ª©c kh·ªèe t·∫≠p ƒëo√†n</div>
                <div class="kpi-value text-warning" style="font-size: 18px">‚ö†Ô∏è TRUNG B√åNH</div>
                <div class="kpi-sub text-warning">SAN √¢m, TGIL bi·∫øn ƒë·ªông</div>
            </div>
        </div>

        <!-- Ranking -->
        <div class="card">
            <div class="card-title">Xem x√©t t·ªïng quan</div>
            
            <div class="ranking-item">
                <div class="ranking-icon critical">
                    üö®
                </div>
                <div class="ranking-info">
                    <div class="ranking-name">S</div>
                    <div class="ranking-detail">
                        Doanh thu: 17.162 M ‚Ä¢ L·ª£i nhu·∫≠n tr∆∞·ªõc thu·∫ø: -1.159 M (-6.8%)
                    </div>
                </div>
                <div class="ranking-badge bg-critical-light text-critical">NGHI√äM TR·ªåNG</div>
            </div>
            
            <div class="ranking-item">
                <div class="ranking-icon excellent">
                    ‚úÖ
                </div>
                <div class="ranking-info">
                    <div class="ranking-name">T</div>
                    <div class="ranking-detail">
                        Doanh thu: 27.733 M ‚Ä¢ L·ª£i nhu·∫≠n tr∆∞·ªõc thu·∫ø: 6.861 M (24.7%)
                    </div>
                </div>
                <div class="ranking-badge bg-excellent-light text-excellent">XU·∫§T S·∫ÆC</div>
            </div>
            
            <div class="ranking-item">
                <div class="ranking-icon average">
                    ‚ö†Ô∏è
                </div>
                <div class="ranking-info">
                    <div class="ranking-name">I</div>
                    <div class="ranking-detail">
                        Doanh thu: 21.489 M ‚Ä¢ L·ª£i nhu·∫≠n tr∆∞·ªõc thu·∫ø: 3.382 M (15.7%)
                    </div>
                </div>
                <div class="ranking-badge bg-average-light text-average">TRUNG B√åNH</div>
            </div>
            
            <button class="btn btn-outline" onclick="switchTab('tab-company')" style="margin-top: 12px;">Xem chi ti·∫øt theo c√¥ng ty ‚Üí</button>
        </div>

        <!-- Chart -->
        <div class="card">
            <div class="card-title">Doanh thu v√† l·ª£i nhu·∫≠n theo th√°ng</div>
            <div id="chart-overview" style="height: 250px;"></div>
        </div>

        <!-- Accordion Insight -->
        <div class="accordion">
            <div class="accordion-header" onclick="toggleAccordion(this)">
                üí° Nh·∫≠n x√©t <span style="font-size: 10px">‚ñº</span>
            </div>
            <div class="accordion-content open">
                <ul>
                    <li><strong>T</strong> d·∫´n ƒë·∫ßu v·ªÅ doanh thu (27.733 M) & t·ª∑ su·∫•t l·ª£i nhu·∫≠n (24.74%).</li>
                    <li><strong>S</strong> l·ªó 1.159 M, kh√¥ng ƒë·∫°t k·∫ø ho·∫°ch (69.7%), LN/DT -6.75%.</li>
                    <li><strong>I</strong> bi√™n l·ª£i nhu·∫≠n 15.74% nh∆∞ng chi ph√≠ bi·∫øn ƒë·ªông.</li>
                    <li>T·ª∑ su·∫•t l√£i g·ªôp to√†n t·∫≠p ƒëo√†n 82.54%, t·ªïng doanh thu 66.383 M, t·ªïng l·ª£i nhu·∫≠n 9.084 M.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: THEO C√îNG TY -->
    <div id="tab-company" class="tab-content">
        <!-- Company Switcher -->
        <div class="segmented-control">
            <button class="segment-btn active" onclick="switchCompany('SAN')">S</button>
            <button class="segment-btn" onclick="switchCompany('TEENNIE')">T</button>
            <button class="segment-btn" onclick="switchCompany('TGIL')">I</button>
        </div>

        <!-- KPI Grid Dynamic -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Doanh Thu (10T)</div>
                <div class="kpi-value" id="comp-revenue">...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">LNTT</div>
                <div class="kpi-value" id="comp-pbt">...</div>
                <div class="kpi-sub" id="comp-margin">...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Ho√†n th√†nh KH</div>
                <div class="kpi-value" id="comp-plan">...</div>
                <div class="kpi-sub" id="comp-plan-sub">...</div>
            </div>
            <div class="kpi-card" id="comp-status-card">
                <div class="kpi-label">Tr·∫°ng th√°i</div>
                <div class="kpi-value" style="font-size: 16px;" id="comp-status">...</div>
                <div class="kpi-sub" id="comp-icon">...</div>
            </div>
        </div>

        <!-- Mini Chart -->
        <div class="card">
            <div class="card-title">Hi·ªáu su·∫•t LNTT theo qu√Ω</div>
            <div id="chart-company" style="height: 180px;"></div>
        </div>

        <!-- Current Situation -->
        <div class="accordion">
            <div class="accordion-header" onclick="toggleAccordion(this)">
                üìå T√¨nh h√¨nh hi·ªán t·∫°i <span style="font-size: 10px">‚ñº</span>
            </div>
            <div class="accordion-content open" id="comp-insight">
                ...
            </div>
        </div>

        <!-- Action Buttons -->
        <button class="btn btn-outline" onclick="goToExpenseTab()">Xem chi ti·∫øt chi ph√≠ ‚Üí</button>
        <button class="btn btn-primary" onclick="goToActionTab()">Xem vi·ªác c·∫ßn l√†m 90 ng√†y ‚Üí</button>
    </div>

    <!-- TAB 3: CHI PH√ç & BI·∫æN ƒê·ªòNG -->
    <div id="tab-expense" class="tab-content">
        <!-- View Toggle -->
        <div class="toggle-container">
            <div class="toggle-wrapper">
                <div class="toggle-bg" id="expense-toggle-bg"></div>
                <button class="toggle-btn active" onclick="toggleExpenseView('ratio')">T·ª∑ l·ªá</button>
                <button class="toggle-btn" onclick="toggleExpenseView('cv')">Bi·∫øn ƒë·ªông</button>
            </div>
        </div>

        <!-- VIEW 1: RATIO -->
        <div id="view-ratio">
            <div class="segmented-control">
                <button class="segment-btn active" onclick="switchExpenseCompany('SAN')">S</button>
                <button class="segment-btn" onclick="switchExpenseCompany('TEENNIE')">T</button>
                <button class="segment-btn" onclick="switchExpenseCompany('TGIL')">I</button>
            </div>
            
            <div class="card">
                <div class="card-title">C∆° c·∫•u chi ph√≠ (% Doanh thu)</div>
                <div id="chart-expense-ratio" style="height: 220px;"></div>
            </div>

            <div class="card bg-warning-light" style="border: 1px solid #ffe0b2; box-shadow: none;">
                <div class="card-title text-warning" style="font-size: 14px;">‚ö†Ô∏è ƒê√°nh gi√°</div>
                <div style="font-size: 13px; color: #555;" id="expense-insight">
                    ...
                </div>
            </div>
        </div>

        <!-- VIEW 2: CV -->
        <div id="view-cv" style="display: none;">
            <div class="card">
                <div class="card-title">Bi·∫øn ƒë·ªông chi ph√≠ (CV%)</div>
                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Ch·ªâ s·ªë c√†ng cao = C√†ng kh√¥ng ·ªïn ƒë·ªãnh (R·ªßi ro)
                </div>
                <div id="chart-cv" style="height: 300px;"></div>
            </div>
            
            <div class="card">
                <div class="card-title">Ph√°t hi·ªán b·∫•t th∆∞·ªùng</div>
                <ul style="font-size: 13px; color: #555; padding-left: 20px; line-height: 1.6;">
                    <li><strong>I:</strong> Bi·∫øn ƒë·ªông gi√° v·ªën th·∫•p nh·∫•t (·ªïn ƒë·ªãnh).</li>
                    <li><strong>S & T:</strong> Chi ph√≠ kh√°c bi·∫øn ƒë·ªông r·∫•t m·∫°nh (>69%), c·∫ßn ki·ªÉm so√°t c√°c kho·∫£n chi b·∫•t th∆∞·ªùng.</li>
                    <li><strong>S:</strong> Chi ph√≠ b√°n h√†ng bi·∫øn ƒë·ªông cao (22.8%), cho th·∫•y chi ti√™u marketing ch∆∞a ƒë·ªÅu ƒë·∫∑n.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 4: H√ÄNH ƒê·ªòNG -->
    <div id="tab-action" class="tab-content">
        <!-- Time Filters -->
        <div class="chips-container">
            <div class="chip active" onclick="filterAction('0-30', this)">0-30 ng√†y</div>
            <div class="chip" onclick="filterAction('30-60', this)">30-60 ng√†y</div>
            <div class="chip" onclick="filterAction('60-90', this)">60-90 ng√†y</div>
        </div>

        <div style="margin-bottom: 16px; font-size: 13px; color: #666; font-style: italic;" id="action-subtitle">
            ∆Øu ti√™n kh·∫©n c·∫•p: C·∫Øt gi·∫£m chi ph√≠ & ·ªîn ƒë·ªãnh
        </div>

        <!-- Dynamic Accordions -->
        <div id="action-list">
            <!-- Injected by JS -->
        </div>

        <div style="margin-top: 24px;">
            <button class="btn btn-primary">üì• T·∫£i k·∫ø ho·∫°ch (PDF)</button>
            <button class="btn btn-outline">Xem b√°o c√°o chi ti·∫øt (Desktop)</button>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('tab-overview')">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">T·ªïng quan</div>
        </div>
        <div class="nav-item" onclick="switchTab('tab-company')">
            <div class="nav-icon">üè¢</div>
            <div class="nav-label">C√¥ng ty</div>
        </div>
        <div class="nav-item" onclick="switchTab('tab-expense')">
            <div class="nav-icon">üí∞</div>
            <div class="nav-label">Chi ph√≠</div>
        </div>
        <div class="nav-item" onclick="switchTab('tab-action')">
            <div class="nav-icon">üìã</div>
            <div class="nav-label">H√†nh ƒë·ªông</div>
        </div>
    </div>

    <!-- DATA & LOGIC -->
    <script>
        const companyData = [{"id": "SAN", "name": "S", "full_name": "SAN", "revenue": 17161.7, "pbt": -1159.1200000000001, "margin": -6.75410944137236, "avg_achieve": 69.68333333333332, "status": "C\u1ea6N CH\u00da \u00dd NGAY", "status_short": "NGHI\u00caM TR\u1eccNG", "status_class": "critical", "icon": "\ud83d\udea8", "expense_ratios": {"COGS": 30.53910743108201, "Selling": 29.578072102414097, "Admin": 42.54741663121952, "Other": 4.08951327665674}, "cv_data": {"COGS": 20.392026824010458, "Selling": 22.831682376052665, "Admin": 7.314908764061695, "Other": 73.23125047246401}, "quarterly_pbt": [203.42000000000004, -474.46000000000004, -645.4], "insight": "LN/DT -6.75%, kh\u00f4ng \u0111\u1ea1t k\u1ebf ho\u1ea1ch doanh thu (69.7%). \u2022 C\u01a1 c\u1ea5u chi ph\u00ed b\u00e1n h\u00e0ng, qu\u1ea3n l\u00fd cao, \u1ea3nh h\u01b0\u1edfng m\u1ea1nh \u0111\u1ebfn l\u1ee3i nhu\u1eadn."}, {"id": "TEENNIE", "name": "T", "full_name": "TEENNIE", "revenue": 27732.76, "pbt": 6861.32, "margin": 24.74084800791555, "avg_achieve": 83.50666666666667, "status": "HO\u1ea0T \u0110\u1ed8NG XU\u1ea4T S\u1eaeC", "status_short": "XU\u1ea4T S\u1eaeC", "status_class": "excellent", "icon": "\u2705", "expense_ratios": {"COGS": 7.933577472995836, "Selling": 39.40812237945304, "Admin": 27.346538894794463, "Other": 2.98693674917318}, "cv_data": {"COGS": 34.31400073767651, "Selling": 27.438497870568884, "Admin": 7.343833221715429, "Other": 69.48280489043562}, "quarterly_pbt": [1785.4299999999998, 2072.47, 2569.35], "insight": "LN/DT 24.74%, \u0111\u1ea1t 83.5% k\u1ebf ho\u1ea1ch. \u2022 T\u1ef7 su\u1ea5t kh\u1ecfe, l\u00e0 \u0111\u1ea7u t\u00e0u l\u1ee3i nhu\u1eadn."}, {"id": "TGIL", "name": "I", "full_name": "TGIL", "revenue": 21488.640000000003, "pbt": 3382.16, "margin": 15.739292947343337, "avg_achieve": 96.10000000000001, "status": "C\u1ea6N \u1ed4N \u0110\u1ecaNH", "status_short": "TRUNG B\u00ccNH", "status_class": "average", "icon": "\u26a0\ufe0f", "expense_ratios": {"COGS": 19.31201788479866, "Selling": 27.666711341434354, "Admin": 35.57340064331665, "Other": 5.273716717298069}, "cv_data": {"COGS": 26.666683386539404, "Selling": 24.45329033522549, "Admin": 6.827251830582928, "Other": 47.604052265115996}, "quarterly_pbt": [707.1300000000001, 1047.57, 1012.5400000000001], "insight": "LN/DT 15.74%, nh\u01b0ng chi ph\u00ed bi\u1ebfn \u0111\u1ed9ng. \u2022 C\u1ea7n \u1ed5n \u0111\u1ecbnh v\u1eadn h\u00e0nh v\u00e0 ki\u1ec3m so\u00e1t chi ph\u00ed."}];
        const actionPlans = {"0-30": {"SAN": ["Ki\u1ec3m to\u00e1n chi ph\u00ed to\u00e0n di\u1ec7n & c\u1eaft gi\u1ea3m kh\u1ea9n c\u1ea5p", "R\u00e0 so\u00e1t chi ph\u00ed lab & h\u1ee3p \u0111\u1ed3ng nh\u00e0 cung c\u1ea5p", "Ph\u00e2n t\u00edch ROI marketing & c\u1eaft k\u00eanh k\u00e9m hi\u1ec7u qu\u1ea3", "\u0110\u00e1nh gi\u00e1 n\u0103ng su\u1ea5t & si\u1ebft ki\u1ec3m so\u00e1t chi ph\u00ed v\u1eadn h\u00e0nh"], "TEENNIE": ["R\u00e0 so\u00e1t chi ph\u00ed t\u0103ng \u0111\u1ed9t bi\u1ebfn Qu\u00fd 2", "Chu\u1ea9n b\u1ecb k\u1ebf ho\u1ea1ch m\u1edf r\u1ed9ng"], "TGIL": ["Ph\u00e2n t\u00edch nguy\u00ean nh\u00e2n g\u1ed1c r\u1ec5 bi\u1ebfn \u0111\u1ed9ng chi ph\u00ed", "R\u00e0 so\u00e1t qu\u1ea3n tr\u1ecb t\u1ed3n kho & nh\u00e0 cung c\u1ea5p"], "GROUP": ["Th\u01b0\u01a1ng l\u01b0\u1ee3ng l\u1ea1i h\u1ee3p \u0111\u1ed3ng cung c\u1ea5p cho to\u00e0n t\u1eadp \u0111o\u00e0n", "Tri\u1ec3n khai b\u00e1o c\u00e1o qu\u1ea3n l\u00fd h\u00e0ng th\u00e1ng"]}, "30-60": {"SAN": ["Kh\u1edfi \u0111\u1ed9ng c\u00e1c s\u00e1ng ki\u1ebfn ph\u1ee5c h\u1ed3i doanh thu"], "TEENNIE": ["X\u00e2y d\u1ef1ng v\u00e0 ph\u00ea duy\u1ec7t k\u1ebf ho\u1ea1ch m\u1edf r\u1ed9ng"], "TGIL": ["Tri\u1ec3n khai quy tr\u00ecnh ph\u00ea duy\u1ec7t chi ph\u00ed", "T\u1eadp trung mua h\u00e0ng n\u1ebfu c\u00f3 th\u1ec3"], "GROUP": ["Tri\u1ec3n khai quy tr\u00ecnh ph\u00ea duy\u1ec7t chi ph\u00ed t\u1eadp \u0111o\u00e0n"]}, "60-90": {"SAN": ["\u0110\u00e1nh gi\u00e1 ti\u1ebfn \u0111\u1ed9 chuy\u1ec3n h\u01b0\u1edbng, \u0111\u01b0a ra quy\u1ebft \u0111\u1ecbnh chi\u1ebfn l\u01b0\u1ee3c"], "TEENNIE": ["Th\u1ef1c hi\u1ec7n \u0111\u1ea7u t\u01b0 t\u0103ng tr\u01b0\u1edfng"], "TGIL": ["Tri\u1ec3n khai c\u00e1c bi\u1ec7n ph\u00e1p \u1ed5n \u0111\u1ecbnh ho\u1ea1t \u0111\u1ed9ng"], "GROUP": ["R\u00e0 so\u00e1t v\u00e0 \u0111\u1eb7t l\u1ea1i m\u1ee5c ti\u00eau Qu\u00fd 4 d\u1ef1a tr\u00ean b\u00e0i h\u1ecdc kinh nghi\u1ec7m"]}};
        let currentCompanyId = 'SAN';
        let currentExpenseCompanyId = 'SAN';
        let currentTimeframe = '0-30';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderOverviewChart();
            updateCompanyTab('SAN');
            updateExpenseRatioChart('SAN');
            renderCVChart();
            renderActions('0-30');
        });

        // --- NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToExpenseTab() {
            switchTab('tab-expense');
            // Simulate click on nav item
            document.querySelectorAll('.nav-item')[2].classList.add('active');
            document.querySelectorAll('.nav-item')[1].classList.remove('active');
        }

        function goToActionTab() {
            switchTab('tab-action');
            document.querySelectorAll('.nav-item')[3].classList.add('active');
            document.querySelectorAll('.nav-item')[1].classList.remove('active');
        }

        // --- TAB 2: COMPANY ---
        function switchCompany(compId) {
            currentCompanyId = compId;
            updateCompanyTab(compId);
            
            // Update active state of buttons
            document.querySelectorAll('#tab-company .segment-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.textContent === (compId === 'SAN' ? 'S' : compId === 'TEENNIE' ? 'T' : 'I')) 
                    btn.classList.add('active');
            });
        }

        function updateCompanyTab(compId) {
            const data = companyData.find(c => c.id === compId);
            if (!data) return;

            // KPI
            document.getElementById('comp-revenue').textContent = formatNumber(data.revenue);
            document.getElementById('comp-pbt').textContent = formatNumber(data.pbt);
            document.getElementById('comp-margin').textContent = `LN/DT: ${data.margin.toFixed(2)}%`;
            
            document.getElementById('comp-plan').textContent = `${data.avg_achieve.toFixed(1)}%`;
            document.getElementById('comp-plan-sub').textContent = data.avg_achieve >= 100 ? '‚úÖ V∆∞·ª£t m·ª•c ti√™u' : data.avg_achieve < 90 ? '‚ö†Ô∏è D∆∞·ªõi m·ª•c ti√™u' : '‚û°Ô∏è ƒê·∫°t m·ª•c ti√™u';
            
            const statusEl = document.getElementById('comp-status');
            const statusCard = document.getElementById('comp-status-card');
            statusEl.textContent = data.status;
            document.getElementById('comp-icon').textContent = data.icon;
            
            // Styling status card
            statusCard.className = 'kpi-card'; // reset
            if (data.status_class === 'critical') statusCard.classList.add('bg-danger-light', 'text-danger');
            else if (data.status_class === 'excellent') statusCard.classList.add('bg-success-light', 'text-success');
            else statusCard.classList.add('bg-warning-light', 'text-warning');

            // Insight
            document.getElementById('comp-insight').textContent = data.insight;

            // Chart
            const trace = {
                x: ['Q1', 'Q2', 'Q3'],
                y: data.quarterly_pbt,
                type: 'bar',
                marker: { color: data.status_class === 'critical' ? '#FE3A45' : data.status_class === 'excellent' ? '#27ae60' : '#f39c12' }
            };
            const layout = {
                margin: { t: 10, b: 30, l: 40, r: 20 },
                yaxis: { title: 'LNTT (Tri·ªáu)' },
                height: 180
            };
            Plotly.newPlot('chart-company', [trace], layout, {staticPlot: true, responsive: true});
        }

        // --- TAB 3: EXPENSE ---
        function toggleExpenseView(view) {
            const bg = document.getElementById('expense-toggle-bg');
            const btns = document.querySelectorAll('.toggle-btn');
            
            if (view === 'ratio') {
                document.getElementById('view-ratio').style.display = 'block';
                document.getElementById('view-cv').style.display = 'none';
                bg.style.transform = 'translateX(0)';
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            } else {
                document.getElementById('view-ratio').style.display = 'none';
                document.getElementById('view-cv').style.display = 'block';
                bg.style.transform = 'translateX(100%)';
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
                renderCVChart(); // Render when shown
            }
        }

        function switchExpenseCompany(compId) {
            currentExpenseCompanyId = compId;
            updateExpenseRatioChart(compId);
            
            // Update buttons
            document.querySelectorAll('#view-ratio .segment-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.textContent === (compId === 'SAN' ? 'S' : compId === 'TEENNIE' ? 'T' : 'I')) 
                    btn.classList.add('active');
            });
        }

        function updateExpenseRatioChart(compId) {
            const data = companyData.find(c => c.id === compId);
            const ratios = data.expense_ratios;
            
            const xValues = [ratios.COGS, ratios.Selling, ratios.Admin, ratios.Other];
            const yValues = ['Gi√° v·ªën', 'B√°n h√†ng', 'Qu·∫£n l√Ω', 'Kh√°c'];
            
            const trace = {
                x: xValues,
                y: yValues,
                type: 'bar',
                orientation: 'h',
                text: xValues.map(v => v.toFixed(1) + '%'),
                textposition: 'auto',
                marker: { color: '#3A464E', opacity: 0.8 }
            };

            const layout = {
                margin: { t: 10, b: 20, l: 80, r: 20 },
                xaxis: { range: [0, 100], title: '% Doanh thu' },
                height: 220
            };
            
            Plotly.newPlot('chart-expense-ratio', [trace], layout, {staticPlot: true, responsive: true});

            // Update Insight
            const insightEl = document.getElementById('expense-insight');
            if (compId === 'SAN') {
                insightEl.innerHTML = '‚Ä¢ T·ª∑ l·ªá CP Qu·∫£n l√Ω (42.6%) v√† B√°n h√†ng (29.6%) qu√° cao, b√≥p ngh·∫πt l·ª£i nhu·∫≠n.<br>‚Ä¢ Gi√° v·ªën chi·∫øm 30.5%, m·ª©c trung b√¨nh.';
            } else if (compId === 'TEENNIE') {
                insightEl.innerHTML = '‚Ä¢ Gi√° v·ªën r·∫•t th·∫•p (7.9%), gi√∫p bi√™n l·ª£i nhu·∫≠n g·ªôp cao.<br>‚Ä¢ Qu·∫£n l√Ω t·ªët c√°c chi ph√≠ v·∫≠n h√†nh.';
            } else {
                insightEl.innerHTML = '‚Ä¢ C√°c ch·ªâ s·ªë ·ªü m·ª©c trung b√¨nh.<br>‚Ä¢ C·∫ßn ch√∫ √Ω bi·∫øn ƒë·ªông gi√° v·ªën trong c√°c th√°ng t·ªõi.';
            }
        }

        function renderCVChart() {
            // Data preparation
            const categories = ['Gi√° v·ªën', 'B√°n h√†ng', 'Qu·∫£n l√Ω', 'Kh√°c'];
            const companies = ['SAN', 'TEENNIE', 'TGIL'];
            const colors = ['#FE3A45', '#27ae60', '#f39c12']; // S=Red, T=Green, I=Orange
            
            const traces = companies.map((compId, idx) => {
                const data = companyData.find(c => c.id === compId).cv_data;
                return {
                    x: categories,
                    y: [data.COGS, data.Selling, data.Admin, data.Other],
                    name: compId === 'SAN' ? 'S' : compId === 'TEENNIE' ? 'T' : 'I',
                    type: 'bar',
                    marker: { color: colors[idx] }
                };
            });

            const layout = {
                barmode: 'group',
                margin: { t: 10, b: 40, l: 40, r: 10 },
                yaxis: { title: 'CV % (Bi·∫øn ƒë·ªông)' },
                legend: { orientation: 'h', y: -0.2 },
                height: 300
            };

            Plotly.newPlot('chart-cv', traces, layout, {staticPlot: false, responsive: true, displayModeBar: false});
        }

        // --- TAB 4: ACTION ---
        function filterAction(timeframe, btn) {
            currentTimeframe = timeframe;
            renderActions(timeframe);
            
            // Update chips
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');

            const sub = document.getElementById('action-subtitle');
            if(timeframe === '0-30') sub.textContent = '∆Øu ti√™n kh·∫©n c·∫•p: C·∫Øt gi·∫£m chi ph√≠ & ·ªîn ƒë·ªãnh';
            else if(timeframe === '30-60') sub.textContent = 'Tri·ªÉn khai c√°c s√°ng ki·∫øn tƒÉng tr∆∞·ªüng & Quy tr√¨nh';
            else sub.textContent = 'Chi·∫øn l∆∞·ª£c d√†i h·∫°n & ƒê·∫ßu t∆∞';
        }

        function renderActions(timeframe) {
            const container = document.getElementById('action-list');
            container.innerHTML = '';
            
            const plans = actionPlans[timeframe];
            const order = ['SAN', 'TEENNIE', 'TGIL', 'GROUP'];
            const names = {'SAN': 'S - C·∫ßn ch√∫ √Ω', 'TEENNIE': 'T', 'TGIL': 'I', 'GROUP': 'C·∫•p T·∫≠p ƒêo√†n'};
            
            order.forEach(key => {
                const items = plans[key];
                if (!items || items.length === 0) return;
                
                const isOpen = (timeframe === '0-30' && key === 'SAN') ? 'open' : '';
                
                let html = `
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        ${names[key]} <span style="font-size: 10px">‚ñº</span>
                    </div>
                    <div class="accordion-content ${isOpen}">
                `;
                
                items.forEach(action => {
                    html += `
                    <div class="action-item">
                        <span class="action-check">‚òê</span>
                        <span>${action}</span>
                    </div>`;
                });
                
                html += `</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- HELPERS ---
        function renderOverviewChart() {
            // D·ªØ li·ªáu doanh thu v√† l·ª£i nhu·∫≠n theo th√°ng
            const months = ["T01", "T02", "T03", "T04", "T05", "T06", "T07", "T08", "T09", "T10"];
            const revenueData = [6319.87, 4673.24, 7692.92, 6174.64, 6839.96, 7501.75, 7069.47, 5723.05, 6616.45, 7771.72];
            const pbtData = [930.44, 195.87, 1569.68, 628.51, 752.22, 1264.85, 1145.53, 1161.45, 629.5, 806.31];
            
            // Trace 1: Doanh thu (C·ªôt)
            const traceRevenue = {
                x: months,
                y: revenueData,
                type: 'bar',
                name: 'Doanh thu',
                marker: { color: '#3A464E', opacity: 0.8 },
                text: revenueData.map(v => formatNumber(v)),
                textposition: 'outside',
                textfont: { size: 10 },
                yaxis: 'y'
            };
            
            // Trace 2: L·ª£i nhu·∫≠n (ƒê∆∞·ªùng)
            const tracePBT = {
                x: months,
                y: pbtData,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'L·ª£i nhu·∫≠n tr∆∞·ªõc thu·∫ø',
                line: { color: '#FE3A45', width: 3 },
                marker: { size: 8, color: '#FE3A45' },
                yaxis: 'y2'
            };
            
            const layout = {
                margin: { t: 20, b: 40, l: 50, r: 50 },
                xaxis: { 
                    title: '',
                    tickangle: -45
                },
                yaxis: {
                    title: 'Doanh thu (M)',
                    side: 'left',
                    titlefont: { color: '#3A464E', size: 11 },
                    tickfont: { color: '#3A464E', size: 10 }
                },
                yaxis2: {
                    title: 'L·ª£i nhu·∫≠n (M)',
                    side: 'right',
                    overlaying: 'y',
                    titlefont: { color: '#FE3A45', size: 11 },
                    tickfont: { color: '#FE3A45', size: 10 }
                },
                showlegend: false,
                height: 250,
                barmode: 'group'
            };
            
            Plotly.newPlot('chart-overview', [traceRevenue, tracePBT], layout, {staticPlot: false, responsive: true, displayModeBar: false});
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(num)) + ' M';
        }

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            const icon = header.querySelector('span');
            icon.textContent = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
        }
    </script>
</body>
</html>
